{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-4">
    <h1 class="mb-4">ğŸ¤– AI íˆ¬ì ê²½ì œì„± ë¶„ì„</h1>
    
    {% if error %}
    <div class="alert alert-danger">
        <strong>ì˜¤ë¥˜:</strong> {{ error }}
    </div>
    {% else %}
    
    <!-- Basic Data Display -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-value">${{ "%.0f"|format(unit_selling_price) }}</div>
                <div class="metric-label">ë‹¨ìœ„ë‹¹ íŒë§¤ê°€ê²© (/í†¤)</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-value">${{ "%.0f"|format(avg_material_cost) }}</div>
                <div class="metric-label">í‰ê·  ì†Œì¬ë¹„ìš© (/í†¤)</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-value">${{ "%.0f"|format(avg_processing_cost) }}</div>
                <div class="metric-label">í‰ê·  ê°€ê³µë¹„ìš© (/í†¤)</div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Form -->
    <div class="analysis-form">
        <div class="section-header">
            <h3>ğŸ“ˆ íŒë§¤ê³„íš</h3>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">5ë…„ì°¨ íŒë§¤ëŸ‰ (í†¤)</label>
                <input type="number" class="form-control" id="year5_volume" value="70000" min="0">
            </div>
            <div class="col-md-4">
                <label class="form-label">6ë…„ì°¨ íŒë§¤ëŸ‰ (í†¤)</label>
                <input type="number" class="form-control" id="year6_volume" value="80000" min="0">
            </div>
            <div class="col-md-4">
                <label class="form-label">7ë…„ì°¨ ì´í›„ íŒë§¤ëŸ‰ (í†¤)</label>
                <input type="number" class="form-control" id="year7_plus_volume" value="100000" min="0">
            </div>
        </div>
        
        <div class="section-header">
            <h3>ğŸ—ï¸ ì‚¬ì—…ê³„íš</h3>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">ì‚¬ì—…ê¸°ê°„ (ë…„)</label>
                <input type="number" class="form-control" id="business_period" value="15" min="1" max="30">
            </div>
            <div class="col-md-4">
                <label class="form-label">ê³µì‚¬ê¸°ê°„ (ë…„)</label>
                <input type="number" class="form-control" id="construction_period" value="4" min="1" max="10">
            </div>
            <div class="col-md-4">
                <label class="form-label">ì´ íˆ¬ìë¹„ (Million USD)</label>
                <input type="number" class="form-control" id="total_investment" value="400.0" min="0.1" step="0.1">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">ê¸°ê³„ì„¤ë¹„ íˆ¬ìë¹„ ë¹„ìœ¨ (%)</label>
                <input type="number" class="form-control" id="machinery_ratio" value="80.0" min="0" max="100">
            </div>
            <div class="col-md-4">
                <label class="form-label">ê±´ì¶•ë¬¼ íˆ¬ìë¹„ ë¹„ìœ¨ (%)</label>
                <input type="number" class="form-control" id="building_ratio" value="20.0" min="0" max="100">
            </div>
            <div class="col-md-4">
                <label class="form-label">í• ì¸ìœ¨ (%)</label>
                <input type="number" class="form-control" id="discount_rate" value="6.92" min="0" step="0.01">
            </div>
        </div>
        
        <div class="section-header">
            <h3>ğŸ’° ì¬ë¬´ê³„íš</h3>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">ì°¨ì…ë¹„ìœ¨ (%)</label>
                <input type="number" class="form-control" id="debt_ratio" value="50.0" min="0" max="100">
            </div>
            <div class="col-md-4">
                <label class="form-label">ì¥ê¸°ì°¨ì…ê¸ˆ ì´ìœ¨ (%)</label>
                <input type="number" class="form-control" id="long_term_rate" value="3.7" min="0" step="0.1">
            </div>
            <div class="col-md-4">
                <label class="form-label">ë²•ì¸ì„¸ìœ¨ (%)</label>
                <input type="number" class="form-control" id="tax_rate" value="25.0" min="0" max="50">
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">ìœ ì˜ˆê¸°ê°„ (ë…„)</label>
                <input type="number" class="form-control" id="grace_period" value="4" min="0">
            </div>
            <div class="col-md-3">
                <label class="form-label">ìƒí™˜ê¸°ê°„ (ë…„)</label>
                <input type="number" class="form-control" id="repayment_period" value="8" min="1">
            </div>
            <div class="col-md-3">
                <label class="form-label">íŒê´€ë¹„ìœ¨ (%)</label>
                <input type="number" class="form-control" id="sales_admin_ratio" value="4.0" min="0">
            </div>
            <div class="col-md-3">
                <!-- Placeholder for alignment -->
            </div>
        </div>
        
        <div class="section-header">
            <h3>ğŸ”„ ìš´ì „ìê¸ˆ</h3>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">ë§¤ì¶œì±„ê¶Œì¼ìˆ˜ (ì¼)</label>
                <input type="number" class="form-control" id="receivables_days" value="30" min="0">
            </div>
            <div class="col-md-3">
                <label class="form-label">ë§¤ì…ì±„ë¬´ì¼ìˆ˜ (ì¼)</label>
                <input type="number" class="form-control" id="payables_days" value="50" min="0">
            </div>
            <div class="col-md-3">
                <label class="form-label">ì œí’ˆì¬ê³ ì¼ìˆ˜ (ì¼)</label>
                <input type="number" class="form-control" id="product_inventory_days" value="30" min="0">
            </div>
            <div class="col-md-3">
                <label class="form-label">ì†Œì¬ì¬ê³ ì¼ìˆ˜ (ì¼)</label>
                <input type="number" class="form-control" id="material_inventory_days" value="40" min="0">
            </div>
        </div>
        
        <div class="text-center">
            <button type="button" class="btn btn-primary btn-lg" id="analyzeBtn">
                ğŸ” íˆ¬ì ê²½ì œì„± ë¶„ì„ ì‹¤í–‰
            </button>
        </div>
    </div>
    
    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <div class="section-header">
            <h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
        </div>
        
        <!-- Metrics -->
        <div class="row mb-4" id="metricsRow">
            <!-- Metrics will be populated here -->
        </div>
        
        <!-- Investment Decision -->
        <div id="investmentDecision" class="mb-4">
            <!-- Decision will be populated here -->
        </div>
        
        <!-- Cash Flow Chart -->
        <div class="mb-4">
            <h4>ğŸ’° í˜„ê¸ˆíë¦„ ë¶„ì„</h4>
            <div id="cashFlowChart" style="height: 500px;"></div>
        </div>
        
        <!-- AI Analysis -->
        <div id="aiAnalysisSection" class="mb-4">
            <!-- AI analysis will be populated here -->
        </div>
    </div>
    
    <!-- Loading -->
    <div id="loadingSection" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ë¶„ì„ ì¤‘...</span>
        </div>
        <h4 class="mt-3">AIê°€ íˆ¬ì ê²½ì œì„±ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h4>
    </div>
    
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('analyzeBtn').addEventListener('click', function() {
    // Show loading
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    
    // Collect form data
    const data = {
        year5_volume: parseInt(document.getElementById('year5_volume').value),
        year6_volume: parseInt(document.getElementById('year6_volume').value),
        year7_plus_volume: parseInt(document.getElementById('year7_plus_volume').value),
        business_period: parseInt(document.getElementById('business_period').value),
        construction_period: parseInt(document.getElementById('construction_period').value),
        total_investment: parseFloat(document.getElementById('total_investment').value) * 1e6,
        machinery_ratio: parseFloat(document.getElementById('machinery_ratio').value),
        building_ratio: parseFloat(document.getElementById('building_ratio').value),
        discount_rate: parseFloat(document.getElementById('discount_rate').value),
        debt_ratio: parseFloat(document.getElementById('debt_ratio').value),
        long_term_rate: parseFloat(document.getElementById('long_term_rate').value),
        tax_rate: parseFloat(document.getElementById('tax_rate').value),
        grace_period: parseInt(document.getElementById('grace_period').value),
        repayment_period: parseInt(document.getElementById('repayment_period').value),
        sales_admin_ratio: parseFloat(document.getElementById('sales_admin_ratio').value),
        receivables_days: parseInt(document.getElementById('receivables_days').value),
        payables_days: parseInt(document.getElementById('payables_days').value),
        product_inventory_days: parseInt(document.getElementById('product_inventory_days').value),
        material_inventory_days: parseInt(document.getElementById('material_inventory_days').value)
    };
    
    // Send analysis request
    fetch('/api/analyze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        document.getElementById('loadingSection').style.display = 'none';
        
        if (result.success) {
            displayResults(result.results);
        } else {
            alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error);
        }
    })
    .catch(error => {
        document.getElementById('loadingSection').style.display = 'none';
        alert('ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
    });
});

function displayResults(results) {
    // Display metrics
    const metricsHtml = `
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">$${results.npv.toFixed(2)}M</div>
                <div class="metric-label">ìˆœí˜„ì¬ê°€ì¹˜ (NPV)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">${results.irr ? results.irr.toFixed(2) + '%' : 'ê³„ì‚°ë¶ˆê°€'}</div>
                <div class="metric-label">ë‚´ë¶€ìˆ˜ìµë¥  (IRR)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">${results.discount_rate.toFixed(2)}%</div>
                <div class="metric-label">í• ì¸ìœ¨</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">$${results.total_investment.toFixed(1)}M</div>
                <div class="metric-label">ì´íˆ¬ìë¹„</div>
            </div>
        </div>
    `;
    document.getElementById('metricsRow').innerHTML = metricsHtml;
    
    // Investment decision
    let decisionHtml = '';
    if (results.irr && results.irr > results.discount_rate) {
        decisionHtml = `
            <div class="alert alert-success">
                <h5>âœ… íˆ¬ì ê¶Œì¥</h5>
                <p>IRR(${results.irr.toFixed(2)}%)ì´ í• ì¸ìœ¨(${results.discount_rate.toFixed(2)}%)ë³´ë‹¤ ë†’ì•„ íˆ¬ì íƒ€ë‹¹ì„±ì´ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        `;
    } else {
        decisionHtml = `
            <div class="alert alert-warning">
                <h5>âš ï¸ íˆ¬ì ì¬ê²€í†  í•„ìš”</h5>
                <p>IRR(${results.irr ? results.irr.toFixed(2) + '%' : 'ê³„ì‚°ë¶ˆê°€'})ì´ í• ì¸ìœ¨(${results.discount_rate.toFixed(2)}%)ë³´ë‹¤ ë‚®ì•„ íˆ¬ìë¥¼ ì¬ê²€í† í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>
        `;
    }
    document.getElementById('investmentDecision').innerHTML = decisionHtml;
    
    // Display chart
    Plotly.newPlot('cashFlowChart', JSON.parse(results.chart).data, JSON.parse(results.chart).layout);
    
    // Display AI analysis
    if (results.ai_analysis) {
        const aiHtml = `
            <div class="section-header">
                <h3>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h3>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">íˆ¬ì ì¶”ì²œë„: ${results.ai_analysis.recommendation || 'N/A'}</h5>
                    <p class="card-text">${results.ai_analysis.summary || 'ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>
                    ${results.ai_analysis.key_insights ? '<h6>ì£¼ìš” ì¸ì‚¬ì´íŠ¸:</h6><ul>' + results.ai_analysis.key_insights.map(insight => '<li>' + insight + '</li>').join('') + '</ul>' : ''}
                    ${results.ai_analysis.risk_factors ? '<h6>ìœ„í—˜ ìš”ì†Œ:</h6><ul>' + results.ai_analysis.risk_factors.map(risk => '<li>' + risk + '</li>').join('') + '</ul>' : ''}
                </div>
            </div>
        `;
        document.getElementById('aiAnalysisSection').innerHTML = aiHtml;
    }
    
    document.getElementById('resultsSection').style.display = 'block';
}
</script>
{% endblock %}